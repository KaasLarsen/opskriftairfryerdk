<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Seneste Opskrifter – Opskrift-Airfryer.dk</title>
<meta name="description" content="Alle de nyeste airfryer opskrifter – søg og filtrér efter kød, grønt, tilbehør, kager og mere." />
<link rel="icon" href="/img/favicon.ico" />
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7373148222153531" crossorigin="anonymous"></script>
<style>
*,*::before,*::after{box-sizing:border-box}html,body{height:100%}
body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#0f172a;background:#fff;line-height:1.6}
a{text-decoration:none;color:inherit}img{max-width:100%;display:block}
:root{--max:1200px;--pad:16px;--text:#0f172a;--muted:#475569;--line:#e2e8f0;--soft:#f8fafc;--accent:#ec4899;--radius:14px;--shadow:0 8px 22px rgba(2,8,23,.06)}
.container{max-width:var(--max);margin:0 auto;padding:0 var(--pad)}
.section{margin:18px 0}
.section-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;gap:12px;flex-wrap:wrap}
.section-head h1{font-size:26px;margin:0}
.tools{display:flex;gap:10px;flex-wrap:wrap;align-items:center;width:100%;position:relative}
.input{padding:14px 16px;border:2px solid var(--accent);border-radius:14px;min-width:260px;width:min(720px,100%);background:#fce7f3;font-size:18px;outline:none}
.input:focus{box-shadow:0 0 0 4px rgba(236,72,153,.15)}
.btn{appearance:none;border:2px solid var(--accent);background:var(--accent);color:#fff;border-radius:14px;padding:12px 16px;font-weight:600;cursor:pointer}
.btn:hover{filter:brightness(.95)} .btn:active{transform:translateY(1px)}
.grid{display:grid;gap:16px}
.grid-3{grid-template-columns:repeat(3,1fr)}
@media(max-width:900px){.grid-3{grid-template-columns:1fr 1fr}}
@media(max-width:560px){.grid-3{grid-template-columns:1fr}}
.card{border:1px solid var(--line);border-radius:14px;background:#fff;box-shadow:var(--shadow);overflow:hidden;display:block;transition:transform .06s ease}
.card:hover{transform:translateY(-2px)}
.thumb-icon{aspect-ratio:16/9;display:grid;place-items:center;background:linear-gradient(180deg,#f8fafc,#fff)}
.thumb-icon svg{width:48px;height:48px;color:var(--accent)}
.card-body{padding:12px 14px}
.card-body h3{font-size:15px;line-height:1.35;margin:0}
.meta{font-size:13px;color:#64748b;margin-top:4px}
.copy{color:#64748b;font-size:13px;text-align:center;margin:26px 0 0}
.skel{height:110px;border:1px solid var(--line);border-radius:14px;background:linear-gradient(90deg,#f8fafc 25%,#eef2f7 37%,#f8fafc 63%);background-size:400% 100%;animation:shimmer 1.2s infinite}
@keyframes shimmer{0%{background-position:100% 0}100%{background-position:-100% 0}}
.adsbygoogle[data-ad-status="unfilled"]{display:none !important}
svg.hidden{position:absolute;width:0;height:0;overflow:hidden}
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
.toolbar-bottom{display:flex;align-items:center;justify-content:space-between;margin-top:10px}
.results{font-size:13px;color:#64748b}

/* Autocomplete */
.suggest{position:absolute;top:60px;left:0;width:min(720px,100%);background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);z-index:30;max-height:320px;overflow:auto;display:none}
.suggest[aria-expanded="true"]{display:block}
.suggest ul{list-style:none;margin:0;padding:6px}
.suggest li{padding:10px 12px;border-radius:10px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:15px}
.suggest li:hover,.suggest li.active{background:#f8fafc}
.suggest .hint{font-size:12px;color:#64748b;margin-left:auto}

/* Kategori-filterbar */
.filters{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 0}
.filter-btn{
  appearance:none;border:1px solid var(--line);background:#fff;color:#0f172a;
  border-radius:999px;padding:8px 12px;font-size:13px;cursor:pointer;box-shadow:var(--shadow)
}
.filter-btn:hover{background:#f8fafc}
.filter-btn.is-active{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
.filter-clear{margin-left:auto}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:12px;background:#fff;color:#64748b;margin-left:8px}
</style>
</head>
<body>
<div data-include="/partials/icons.html"></div>
<div data-include="/partials/header.html"></div>

<main class="container">
  <section class="section">
    <div class="section-head" style="flex-direction:column;align-items:flex-start">
      <h1>Seneste Opskrifter</h1>

      <!-- Søg + filtre -->
      <div class="tools" role="search" aria-label="Søg i opskrifter">
        <label class="sr-only" for="q">Søg i opskrifter</label>
        <input id="q" class="input" type="search" placeholder="Søg i opskrifter… (fx frikadeller, broccoli, brownies)" autocomplete="off" aria-autocomplete="list" aria-controls="suggestions" aria-expanded="false" />
        <button id="searchBtn" class="btn" type="button" aria-label="Søg">Søg</button>
        <span id="activeFilter" class="badge" style="display:none"></span>

        <!-- Autocomplete dropdown -->
        <div id="suggestions" class="suggest" role="listbox" aria-expanded="false" aria-label="Forslag"></div>

        <!-- Kategori-knapper -->
        <div class="filters" aria-label="Filtrér kategorier">
          <button class="filter-btn" data-cat="Alle">Alle</button>
          <button class="filter-btn" data-cat="Kylling">Kylling</button>
          <button class="filter-btn" data-cat="Oksekød">Oksekød</button>
          <button class="filter-btn" data-cat="Svinekød">Svinekød</button>
          <button class="filter-btn" data-cat="Fisk">Fisk</button>
          <button class="filter-btn" data-cat="Grønt">Grønt</button>
          <button class="filter-btn" data-cat="Tilbehør">Tilbehør</button>
          <button class="filter-btn" data-cat="Brød">Brød</button>
          <button class="filter-btn" data-cat="Dessert">Dessert</button>
          <button class="filter-btn" data-cat="Snacks">Snacks</button>
          <button class="filter-btn" data-cat="Asiatisk">Asiatisk</button>
          <button class="filter-btn" data-cat="Mexicansk">Mexicansk</button>
          <button class="filter-btn" data-cat="Indisk">Indisk</button>
          <button class="filter-btn" data-cat="Halloween">Halloween</button>
          <button class="filter-btn filter-clear" data-cat="__clear">Ryd filter</button>
        </div>
      </div>
    </div>

    <div style="margin:8px 0 18px">
      <ins class="adsbygoogle" style="display:block"
           data-ad-client="ca-pub-7373148222153531"
           data-ad-slot="1234567890"
           data-ad-format="auto"
           data-full-width-responsive="true"></ins>
      <script>(adsbygoogle=window.adsbygoogle||[]).push({});</script>
    </div>

    <div id="grid" class="grid grid-3" aria-live="polite">
      <div class="skel"></div><div class="skel"></div><div class="skel"></div>
    </div>

    <div class="toolbar-bottom">
      <p id="empty" class="copy" style="display:none">Ingen opskrifter matcher din søgning/filtrering.</p>
      <div class="results" id="results">Indlæser…</div>
    </div>
  </section>
</main>

<div data-include="/partials/footer.html"></div>
<script src="/assets/include.js?v=4"></script>

<!-- Seneste: robust sitemap + søgning + kategori-filtre -->
<script>
const RECIPES_SITEMAP_URL = '/recipes-sitemap.xml';
const FALLBACK_SITEMAP_URL = '/sitemap.xml';
const CACHE_KEY = 'RECIPES_CACHE_v9'; // bump ved ændringer
const CACHE_TTL_MS = 12 * 60 * 60 * 1000;

const grid = document.getElementById('grid');
const empty = document.getElementById('empty');
const resultsEl = document.getElementById('results');
const q = document.getElementById('q');
const searchBtn = document.getElementById('searchBtn');
const suggestionsEl = document.getElementById('suggestions');
const activeFilterBadge = document.getElementById('activeFilter');

const debounce = (fn, ms=200) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
const capitalizeWords = s => s.replace(/\b\w/g, c => c.toUpperCase());

/* === Normalisering (æ/ø/å) === */
function norm(s=''){
  return s.toLowerCase().normalize('NFKD')
    .replace(/\p{Diacritic}/gu,'')
    .replace(/æ/g,'ae').replace(/ø/g,'oe').replace(/å/g,'aa');
}

/* === Ikon ud fra slug === */
function iconFromSlug(slug){
  const s = (slug||'').toLowerCase();
  if (s.includes('kylling')||s.includes('chicken')) return 'chicken';
  if (s.includes('okse')||s.includes('boef')||s.includes('bøf')||s.includes('koed')||s.includes('kød')) return 'cow';
  if (s.includes('svin')||s.includes('flaesk')||s.includes('flæsk')||s.includes('medister')||s.includes('moerbrad')||s.includes('mørbrad')) return 'pig';
  if (s.includes('and')) return 'duck';
  if (s.includes('fisk')||s.includes('laks')||s.includes('torsk')||s.includes('tun')||s.includes('sej')||s.includes('roedspaette')||s.includes('rødspætte')) return 'fish';
  if (s.includes('broccoli')||s.includes('grønt')||s.includes('groent')||s.includes('grontsag')||s.includes('grøntsag')) return 'leaf';
  if (s.includes('toast')||s.includes('brød')||s.includes('broed')||s.includes('naan')||s.includes('focaccia')||s.includes('panini')||s.includes('bolle')||s.includes('flutes')||s.includes('pita')) return 'bread';
  if (s.includes('kage')||s.includes('brownie')||s.includes('donut')||s.includes('cookie')||s.includes('scone')||s.includes('tærte')||s.includes('taerte')||s.includes('crumble')||s.includes('muffin')||s.includes('vaffel')) return 'cake';
  if (s.includes('chips')||s.includes('tortilla')||s.includes('pommes')||s.includes('fries')) return 'chips';
  if (s.includes('pizza')) return 'pizza';
  if (s.includes('burger')) return 'burger';
  return 'book';
}
function formatDate(d){ try{ return new Intl.DateTimeFormat('da-DK',{day:'2-digit',month:'short',year:'numeric'}).format(d);}catch{return '';} }
function card(r){
  const icon = iconFromSlug(r.slug);
  const dateStr = r.date ? formatDate(r.date) : '';
  const meta = [dateStr, r.blurb||'Se opskriften'].filter(Boolean).join(' · ');
  return `
    <a class="card" href="${r.slug}">
      <div class="thumb-icon"><svg><use href="#${icon}" xlink:href="#${icon}"></use></svg></div>
      <div class="card-body">
        <h3>${r.title}</h3>
        <p class="meta">${meta}</p>
      </div>
    </a>`;
}

/* === Kategorier fra slug + titel (til filtre) === */
function categoriesFrom(title, slug){
  const s = norm((title||'')+' '+(slug||''));
  const cats = new Set();

  // primære
  if (/\bkylling|chicken|vinger|drumstick|souvlaki|shawarma|tikka|katsu\b/.test(s)) cats.add('Kylling');
  if (/\bokse|boef|bof|koed|koefte|roastbeef|ribeye|cheesesteak|stroganoff|gryde|chili con carne\b/.test(s)) cats.add('Oksekød');
  if (/\bsvin|flaesk|flask|rib|porchetta|medister|moerbrad|mørbrad|karbonade|kotelet|char siu\b/.test(s)) cats.add('Svinekød');
  if (/\bfisk|laks|torsk|tun|sej|reje|rejer|kammusling|musling|calamari|fiskefileter|fiskepinde\b/.test(s)) cats.add('Fisk');
  if (/\bbroccoli|grontsag|groentsag|salat|aubergine|eggplant|squash|svamp|champignon|portobello|kartoffel|rodfrugt|pastinak|gulerod|kik(ae|æ)rte|tofu|tempeh\b/.test(s)) cats.add('Grønt');
  if (/\btilbehoer|tilbehør|pommes|fritter|chips|majskolbe|croutoner|sides?\b/.test(s)) cats.add('Tilbehør');
  if (/\bbr(oe|ø)d|bolle|naan|focaccia|toast|flutes|pita|bagels|ciabatta|bagning|bagte\b/.test(s)) cats.add('Brød');
  if (/\bdessert|kage|brownie|muffin|cookie|scone|taerte|tærte|vaffel|donut|cheesecake|smuldre|crumble|churros|is\b/.test(s)) cats.add('Dessert');
  if (/\bsnack|nachos|chips|sticks|bites|fries|popcorn|poppers|wrap\b/.test(s)) cats.add('Snacks');

  // cuisine tags
  if (/\bindisk|tandoori|butter chicken|masala|paneer|dal|biryani\b/.test(s)) cats.add('Indisk');
  if (/\bmexicansk|taco|tacos|enchilada|burrito|tostada|quesadilla|nachos|al pastor|empanadas|tamales\b/.test(s)) cats.add('Mexicansk');
  if (/\basia|asiatisk|teriyaki|soy(a)?|gyoza|samosa|shawarma|falafel|hummus|tabouleh|fattoush|souvlaki|spanakopita\b/.test(s)) cats.add('Asiatisk');

  // sæson/tema
  if (/\bhalloween|gr(oe|ø)skar|pumpkin|spooky|uhygge|monster\b/.test(s)) cats.add('Halloween');
  if (/\bjul|jule|nyt(a|å)r|christmas|holiday\b/.test(s)) cats.add('Jul');

  return Array.from(cats);
}

/* === XML helpers (namespace-tolerant) === */
function parseXML(t){ return new DOMParser().parseFromString(t,'application/xml'); }
function extractUrlEntries(xmlDoc){
  let urlNodes = Array.from(xmlDoc.getElementsByTagName('url'));
  if (!urlNodes.length) urlNodes = Array.from(xmlDoc.getElementsByTagNameNS('*','url'));
  return urlNodes.map(n=>{
    const locNode  = n.getElementsByTagName('loc')[0]     || n.getElementsByTagNameNS('*','loc')[0];
    const lastNode = n.getElementsByTagName('lastmod')[0] || n.getElementsByTagNameNS('*','lastmod')[0];
    const loc = locNode?.textContent?.trim() || '';
    const last = lastNode?.textContent?.trim() || '';
    return { loc, lastmod: last };
  }).filter(u=>u.loc);
}
function extractSitemapsFromIndex(xmlDoc){
  let smNodes = Array.from(xmlDoc.getElementsByTagName('sitemap'));
  if (!smNodes.length) smNodes = Array.from(xmlDoc.getElementsByTagNameNS('*','sitemap'));
  return smNodes.map(n=>{
    const locNode = n.getElementsByTagName('loc')[0] || n.getElementsByTagNameNS('*','loc')[0];
    return locNode?.textContent?.trim();
  }).filter(Boolean);
}

/* === Fetch helpers (med cache-bust) === */
function addBust(url){
  try{ const u = new URL(url, location.origin); u.searchParams.set('cb', String(Date.now())); return u.pathname + u.search; }
  catch{ return url; }
}
async function fetchXML(url){
  const res = await fetch(addBust(url), { cache:'no-store', credentials:'same-origin' });
  if (!res.ok) throw new Error(url+': '+res.status);
  return parseXML(await res.text());
}
async function fetchText(url){
  const res = await fetch(addBust(url), { cache:'no-store', credentials:'same-origin' });
  if (!res.ok) throw new Error(url+': '+res.status);
  return await res.text();
}

/* === Dato + meta fra side-HTML === */
function extractDateFromHTML(html){
  try{
    const doc = new DOMParser().parseFromString(html,'text/html');
    const ld = Array.from(doc.querySelectorAll('script[type="application/ld+json"]'));
    for (const s of ld){
      try{
        const json = JSON.parse(s.textContent.trim());
        const arr = Array.isArray(json) ? json : [json];
        for (const obj of arr){
          const dp = obj?.datePublished || obj?.dateModified;
          if (dp){ const d = new Date(dp); if (!isNaN(d)) return d; }
          if (Array.isArray(obj?.['@graph'])){
            for (const g of obj['@graph']){
              const dp2 = g?.datePublished || g?.dateModified;
              if (dp2){ const d2 = new Date(dp2); if (!isNaN(d2)) return d2; }
            }
          }
        }
      }catch{}
    }
    const m = doc.querySelector('meta[property="article:published_time"],meta[name="date"],meta[name="publish-date"],meta[itemprop="datePublished"]');
    if (m){ const val = m.content || m.value; const d = new Date(val); if (!isNaN(d)) return d; }
  }catch{}
  return null;
}
async function fetchMeta(url, fallbackDate){
  try{
    const html = await fetchText(url);
    const doc  = new DOMParser().parseFromString(html,'text/html');
    const h1   = doc.querySelector('h1')?.textContent?.trim();
    const title= h1 || doc.querySelector('title')?.textContent?.trim() || url.split('/').pop().replace('.html','').replace(/-/g,' ');
    const blurb= doc.querySelector('meta[name="description"]')?.content?.trim() || 'Se opskriften';
    let date   = extractDateFromHTML(html) || fallbackDate || null;
    return { title, blurb, date };
  }catch{ return null; }
}

/* === Sitemap loader (index -> urlset) === */
async function loadFromSitemaps(){
  let doc;
  try{ doc = await fetchXML(RECIPES_SITEMAP_URL); }
  catch{ doc = await fetchXML(FALLBACK_SITEMAP_URL); }

  const rootName = (doc.documentElement?.nodeName||'').toLowerCase();
  async function collectFromUrlset(xml){
    const urls = extractUrlEntries(xml);
    return urls
      .map(u=>{
        const loc = u.loc;
        const last = u.lastmod ? new Date(u.lastmod) : null;
        const p = new URL(loc, location.origin).pathname;
        if (!p.endsWith('.html')) return null;
        if (!p.startsWith('/opskrifter/')) return null;
        return {
          href: loc,
          slugPath: p,
          lastmodDate: last,
          baseTitle: p.split('/').pop().replace('.html','').replace(/-/g,' ').trim()
        };
      })
      .filter(Boolean);
  }

  let entries = [];
  if (rootName.includes('urlset')){
    entries = await collectFromUrlset(doc);
  } else if (rootName.includes('sitemapindex')){
    const maps = extractSitemapsFromIndex(doc);
    for (const sm of maps){
      try{
        const sub = await fetchXML(sm);
        if ((sub.documentElement?.nodeName||'').toLowerCase().includes('urlset')){
          entries.push(...await collectFromUrlset(sub));
        }
      }catch(e){ console.warn('Undersitemap fejl:', sm, e); }
    }
  } else {
    entries = await collectFromUrlset(doc);
  }

  // Basis items (hurtig render)
  const items = entries.map(e => ({
    slug: e.slugPath,
    title: capitalizeWords(e.baseTitle),
    blurb: 'Se opskriften',
    date: e.lastmodDate || null,
    cats: [] // udfyldes ved enrich
  }));

  // Sortér nyeste først
  items.sort((a,b)=>{
    const ad = a.date ? a.date.getTime() : 0;
    const bd = b.date ? b.date.getTime() : 0;
    if (bd !== ad) return bd - ad;
    return a.title.localeCompare(b.title, 'da');
  });

  return { items, entries };
}

/* === Cache === */
function readCache(){
  try{
    const c = JSON.parse(localStorage.getItem(CACHE_KEY)||'null');
    if (c && (Date.now()-c.ts) < CACHE_TTL_MS){
      return (c.items||[]).map(r=>({...r, date: r.date ? new Date(r.date) : null }));
    }
  }catch{}
  return null;
}
function writeCache(items){
  try{
    const toCache = items.map(r=>({...r, date: r.date ? r.date.toISOString() : null }));
    localStorage.setItem(CACHE_KEY, JSON.stringify({ ts: Date.now(), items: toCache }));
  }catch{}
}

/* === Søgning + filtrering === */
let ALL = [];
let ALL_NORM = [];
let ACTIVE_CAT = ''; // ''=ingen filter

function buildNormIndex(list){
  ALL_NORM = list.map(r => ({
    t: norm(r.title||''),
    b: norm(r.blurb||''),
    s: norm(r.slug||'')
  }));
}
function matchesCategory(r){
  if (!ACTIVE_CAT || ACTIVE_CAT==='Alle') return true;
  return (r.cats||[]).some(c => c.toLowerCase() === ACTIVE_CAT.toLowerCase());
}
function render(list){
  const termRaw = (q.value||'').trim();
  const term = norm(termRaw);
  // vi matcher mod ALLE, men filtrerer på kategori bagefter
  let base = list;
  if (term){
    base = list.filter((r, i) => {
      const n = ALL_NORM[i]; // samme indeks fordi list===ALL
      return n.t.includes(term) || n.b.includes(term) || n.s.includes(term);
    });
  }
  const out = base.filter(matchesCategory);

  resultsEl.textContent = `${out.length} resultat${out.length===1?'':'er'}`;
  if(!out.length){ grid.innerHTML=''; empty.style.display='block'; }
  else{
    grid.innerHTML = out.map(card).join('');
    empty.style.display='none';
  }

  // badge
  if (ACTIVE_CAT && ACTIVE_CAT!=='Alle'){
    activeFilterBadge.textContent = `Filter: ${ACTIVE_CAT}`;
    activeFilterBadge.style.display = 'inline-block';
  } else {
    activeFilterBadge.style.display = 'none';
  }
}

/* === Autocomplete === */
let SUG_INDEX = [];
function buildSuggestIndex(items, cap=120){
  const stop = new Set(['i','og','med','også','en','et','af','til','på','paa','fra','den','det','de','eller','for','the','and']);
  const freq = new Map();
  for (const r of items){
    const base = norm((r.title + ' ' + r.slug.replace('/opskrifter/','').replace('.html','').replace(/-/g,' ')));
    for (const raw of base.split(/\s+/)){
      const w = raw.replace(/[^\w]/g,'');
      if (w.length<3 || stop.has(w)) continue;
      freq.set(w, (freq.get(w)||0)+1);
    }
  }
  const tokens = Array.from(freq.entries()).sort((a,b)=>b[1]-a[1]).slice(0,cap).map(([term,score])=>({term,score}));
  SUG_INDEX = tokens;
}
function showSuggestions(list){
  if (!list.length){ suggestionsEl.setAttribute('aria-expanded','false'); suggestionsEl.style.display='none'; return; }
  const html = '<ul>' + list.map((s,i)=>`
    <li role="option" data-value="${s.value.replace(/"/g,'&quot;')}" class="${i===0?'active':''}">
      <span>${s.label}</span>
      <span class="hint">${s.hint||''}</span>
    </li>`).join('') + '</ul>';
  suggestionsEl.innerHTML = html;
  suggestionsEl.style.display='block';
  suggestionsEl.setAttribute('aria-expanded','true');
  q.setAttribute('aria-expanded','true');
}
function hideSuggestions(){
  suggestionsEl.innerHTML=''; suggestionsEl.style.display='none';
  suggestionsEl.setAttribute('aria-expanded','false'); q.setAttribute('aria-expanded','false');
}
function suggest(){
  const term = norm((q.value||'').trim());
  if (term.length < 2){
    const popular = ['kylling','kartoffel','svin','okse','laks','grøntsager','dessert','pizza']
      .map(t=>({label:t,value:t,hint:'populær'}));
    showSuggestions(popular); return;
  }
  const titleMatches = ALL
    .filter(r => norm(r.title||'').includes(term))
    .slice(0,6)
    .map(r => ({ label: r.title, value: r.title, hint: 'opskrift' }));
  const tokenMatches = SUG_INDEX
    .filter(x => x.term.includes(term) && !titleMatches.some(t => norm(t.value)===x.term))
    .slice(0, 8 - titleMatches.length)
    .map(x => ({ label: x.term, value: x.term, hint: `${x.score}+` }));
  showSuggestions([...titleMatches, ...tokenMatches]);
}

/* === Progressiv berigelse === */
async function enrich(items, entries){
  const bySlug = new Map(items.map(r => [r.slug, r]));
  const concurrency = 10; let i = 0;
  async function worker(){
    while(i < entries.length){
      const e = entries[i++]; const cur = bySlug.get(e.slugPath);
      const meta = await fetchMeta(e.slugPath, e.lastmodDate);
      if (meta){
        cur.title = meta.title || cur.title;
        cur.blurb = meta.blurb || cur.blurb;
        cur.date  = meta.date  || cur.date;
      }
      // kategorier
      cur.cats = categoriesFrom(cur.title, cur.slug);

      if (i % 5 === 0) writeCache(items);
    }
  }
  await Promise.all(Array.from({length: concurrency}, worker));
  writeCache(items);
  buildNormIndex(items);
  render(items);
}

/* === UI events === */
const onSearch = debounce(()=>{ render(ALL); hideSuggestions(); },120);
q.addEventListener('input', ()=>{ onSearch(); suggest(); });
q.addEventListener('focus', ()=> suggest());
q.addEventListener('blur', ()=> setTimeout(hideSuggestions, 120));
searchBtn.addEventListener('click', ()=>{ render(ALL); hideSuggestions(); });
q.addEventListener('keydown', (e)=>{
  const open = suggestionsEl.getAttribute('aria-expanded')==='true';
  const items = Array.from(suggestionsEl.querySelectorAll('li'));
  const activeIdx = items.findIndex(li => li.classList.contains('active'));
  if (e.key==='Enter'){
    if (open && activeIdx>=0){ q.value = items[activeIdx].dataset.value || ''; }
    render(ALL); hideSuggestions(); e.preventDefault();
  } else if (e.key==='ArrowDown' && open){
    const next = Math.min(activeIdx+1, items.length-1);
    items.forEach(li=>li.classList.remove('active')); if (items[next]) items[next].classList.add('active'); e.preventDefault();
  } else if (e.key==='ArrowUp' && open){
    const prev = Math.max(activeIdx-1, 0);
    items.forEach(li=>li.classList.remove('active')); if (items[prev]) items[prev].classList.add('active'); e.preventDefault();
  } else if (e.key==='Escape'){
    q.value=''; render(ALL); hideSuggestions();
  }
});
suggestionsEl.addEventListener('mousedown', (e)=>{
  const li = e.target.closest('li'); if (!li) return;
  q.value = li.dataset.value || ''; render(ALL); hideSuggestions();
});

/* === Filter-knapper === */
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('.filter-btn'); if (!btn) return;
  const cat = btn.dataset.cat;
  if (cat === '__clear'){ ACTIVE_CAT=''; document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('is-active')); render(ALL); return; }
  if (cat === 'Alle'){ ACTIVE_CAT=''; }
  else { ACTIVE_CAT = cat; }
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.toggle('is-active', b===btn && cat!=='__clear'));
  render(ALL);
});

/* === init === */
(async function init(){
  const t0 = performance.now();

  // URL-parameter ?soeg= og ?kat=
  try{
    const params = new URLSearchParams(location.search);
    const prefill = params.get('soeg') || params.get('søg') || '';
    if (prefill) q.value = decodeURIComponent(prefill);
    const preCat = params.get('kat') || '';
    if (preCat){ ACTIVE_CAT = preCat; }
  }catch{}

  // cache først
  let items = readCache();
  if (items){
    // hvis cache er ældre struktur, udfyld cats nu
    for (const it of items){ if (!Array.isArray(it.cats)) it.cats = categoriesFrom(it.title, it.slug); }
    ALL = items; buildNormIndex(ALL); buildSuggestIndex(ALL); render(ALL);
    resultsEl.textContent += ' • (cache)';
  } else {
    try{
      const { items: baseItems, entries } = await loadFromSitemaps();
      // init cats hurtigt fra slug/titel
      for (const it of baseItems){ it.cats = categoriesFrom(it.title, it.slug); }
      ALL = baseItems; buildNormIndex(ALL); buildSuggestIndex(ALL); render(ALL);
      const t1 = performance.now();
      resultsEl.textContent = `${ALL.length} opskrifter • klar på ${(t1 - t0 | 0)} ms`;
      // enrich i baggrunden
      enrich(ALL, entries);
    }catch(e){
      console.error(e);
      resultsEl.textContent = 'Kunne ikke indlæse opskrifter – tjek at /recipes-sitemap.xml eller /sitemap.xml findes og ikke er tom.';
      ALL = []; try{ localStorage.removeItem(CACHE_KEY); }catch{}
      render(ALL);
    }
  }

  // hvis der er forudfyldt søgning eller kategori, apply
  if (q.value.trim() || ACTIVE_CAT) render(ALL);
})();
</script>
</body>
</html>
